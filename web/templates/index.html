<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NewRAG - Intelligent Document Search</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .flag-icon {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .flag-icon:hover {
            transform: scale(1.1);
        }
        /* Highlight styles for search results */
        .highlight-content mark {
            background-color: #fef08a;
            color: #854d0e;
            padding: 2px 4px;
            border-radius: 3px;
            font-weight: 500;
        }
        
        /* Line clamp for text truncation */
        .line-clamp-4 {
            display: -webkit-box;
            -webkit-line-clamp: 4;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }
    </style>
</head>
<body class="bg-slate-50 font-sans text-slate-900">
    <div class="min-h-screen flex">
        <!-- Sidebar -->
        <div class="w-64 bg-slate-900 text-white p-6 shadow-xl z-10">
            <div class="flex items-center justify-between mb-8">
                <h1 class="text-2xl font-bold tracking-tight bg-gradient-to-r from-blue-400 to-indigo-400 bg-clip-text text-transparent">
                    <i class="fas fa-brain mr-2 text-blue-400"></i>
                    <span data-i18n="app.title">NewRAG</span>
                </h1>
            </div>
            
            <!-- Language Switcher -->
            <div class="mb-6 flex items-center gap-3 pb-4 border-b border-gray-700">
                <span class="text-sm text-gray-400" data-i18n="app.language">Language</span>
                <button onclick="switchLanguage('zh')" id="lang-zh" class="px-3 py-1 rounded text-sm opacity-50 hover:opacity-100 hover:bg-gray-800 transition-all">
                    ‰∏≠Êñá
                </button>
                <button onclick="switchLanguage('en')" id="lang-en" class="px-3 py-1 rounded text-sm opacity-50 hover:opacity-100 hover:bg-gray-800 transition-all">
                    EN
                </button>
            </div>
            
            <nav class="space-y-2">
                <button onclick="showTab('upload')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 tab-btn active" data-tab="upload">
                    <i class="fas fa-upload mr-2"></i> <span data-i18n="nav.upload">Upload</span>
                </button>
                <button onclick="showTab('search')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 tab-btn" data-tab="search">
                    <i class="fas fa-search mr-2"></i> <span data-i18n="nav.search">Search</span>
                </button>
                <button onclick="showTab('stats')" class="w-full text-left px-4 py-3 rounded-lg hover:bg-gray-800 tab-btn" data-tab="stats">
                    <i class="fas fa-chart-bar mr-2"></i> <span data-i18n="nav.stats">Statistics</span>
                </button>
            </nav>
        </div>

        <!-- Main Content -->
        <div class="flex-1 p-8">
            <!-- Upload Tab -->
            <div id="upload-tab" class="tab-content">
                <h2 class="text-3xl font-bold mb-6" data-i18n="upload.title">Upload Documents</h2>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div id="drop-zone" class="border-2 border-dashed border-gray-300 rounded-lg p-12 text-center hover:border-blue-500 transition-colors cursor-pointer">
                        <i class="fas fa-cloud-upload-alt text-6xl text-gray-400 mb-4"></i>
                        <p class="text-lg text-gray-600 mb-2" data-i18n="upload.dragDrop">Drag & drop files here</p>
                        <p class="text-sm text-gray-500 mb-1" data-i18n="upload.clickBrowse">or click to browse</p>
                        <p class="text-xs text-gray-400 mt-2">
                            <i class="fas fa-info-circle mr-1"></i>
                            <span data-i18n="upload.autoDetect">Supports PDF, ZIP, JPG/JPEG, PNG, PPTX. ZIP archives will be extracted automatically.</span>
                        </p>
                        <input type="file" id="file-input" class="hidden" accept=".pdf,.zip,.jpg,.jpeg,.png,.pptx" multiple>
                    </div>

                    <!-- Selected Files Display -->
                    <div id="selected-files" class="mt-4 hidden">
                        <h4 class="text-sm font-medium text-gray-700 mb-2" data-i18n="upload.selectedFiles">Selected Files:</h4>
                        <div id="files-list" class="space-y-2"></div>
                    </div>

                    <div class="mt-4 grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="upload.category">Category</label>
                            <input type="text" id="category" class="w-full px-4 py-2 border rounded-lg" data-i18n-placeholder="upload.categoryPlaceholder">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="upload.author">Author</label>
                            <input type="text" id="author" class="w-full px-4 py-2 border rounded-lg" data-i18n-placeholder="upload.authorPlaceholder">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="upload.ocrEngine">OCR Engine</label>
                            <select id="ocr-engine" class="w-full px-4 py-2 border rounded-lg">
                                <option value="easy" selected>EasyOCR - Âø´ÈÄü (Fast, Basic)</option>
                                <option value="paddle">PaddleOCR - ÊúÄÂº∫ (Best, Multi-direction Chinese+English)</option>
                                <option value="vision">Apple Vision - È´òÁ≤æÂ∫¶ (macOS Only, High Accuracy)</option>
                            </select>
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="upload.tags">Tags (comma-separated)</label>
                            <input type="text" id="tags" class="w-full px-4 py-2 border rounded-lg" data-i18n-placeholder="upload.tagsPlaceholder">
                        </div>
                        <div class="col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="upload.description">Description</label>
                            <textarea id="description" class="w-full px-4 py-2 border rounded-lg" rows="2" data-i18n-placeholder="upload.descriptionPlaceholder"></textarea>
                        </div>
                    </div>

                    <button onclick="uploadFiles()" class="mt-4 w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition-colors">
                        <i class="fas fa-upload mr-2"></i> <span data-i18n="upload.button">Upload & Process</span>
                    </button>
                </div>

                <div id="upload-status" class="hidden bg-white rounded-lg shadow p-6">
                    <h3 class="text-lg font-semibold mb-4" data-i18n="upload.status">Processing Status</h3>
                    <div id="status-content"></div>
                </div>
            </div>

            <!-- Search Tab -->
            <div id="search-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6" data-i18n="search.title">Search Documents</h2>
                
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex gap-4">
                        <input type="text" id="search-query" class="flex-1 px-4 py-3 border rounded-lg text-lg" data-i18n-placeholder="search.queryPlaceholder">
                        <button onclick="performSearch()" class="bg-blue-600 text-white px-8 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                            <i class="fas fa-search mr-2"></i> <span data-i18n="search.button">Search</span>
                        </button>
                    </div>

                    <div class="mt-4 grid grid-cols-4 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="search.categoryFilter">Category Filter</label>
                            <input type="text" id="filter-category" class="w-full px-4 py-2 border rounded-lg" data-i18n-placeholder="search.optional">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="search.authorFilter">Author Filter</label>
                            <input type="text" id="filter-author" class="w-full px-4 py-2 border rounded-lg" data-i18n-placeholder="search.optional">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="search.typeFilter">File Type Filter</label>
                            <input type="text" id="filter-type" class="w-full px-4 py-2 border rounded-lg" data-i18n-placeholder="search.optional">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2" data-i18n="search.results">Results</label>
                            <input type="number" id="search-k" class="w-full px-4 py-2 border rounded-lg" value="5" min="1" max="20">
                        </div>
                    </div>

                    <div class="mt-4">
                        <label class="flex items-center">
                            <input type="checkbox" id="use-hybrid" class="mr-2" checked>
                            <span class="text-sm text-gray-700" data-i18n="search.hybrid">Use Hybrid Search (Vector + BM25)</span>
                        </label>
                    </div>
                </div>

                <div id="search-results" class="space-y-4"></div>
            </div>

            <!-- Statistics Tab -->
            <div id="stats-tab" class="tab-content hidden">
                <h2 class="text-3xl font-bold mb-6" data-i18n="stats.title">System Statistics</h2>
                
                <!-- ES Index Status -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <h3 class="text-lg font-semibold mb-4" data-i18n="stats.esIndexStatus">Elasticsearch Index Status</h3>
                    <div class="grid grid-cols-3 gap-4">
                        <div>
                            <div class="text-sm text-gray-600" data-i18n="stats.indexName">Index Name</div>
                            <div class="text-lg font-semibold" id="es-index-name">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600" data-i18n="stats.status">Status</div>
                            <div class="text-lg font-semibold" id="es-index-status">-</div>
                        </div>
                        <div>
                            <div class="text-sm text-gray-600" data-i18n="stats.docCount">Document Count</div>
                            <div class="text-lg font-semibold text-blue-600" id="es-doc-count">-</div>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-5 gap-6 mb-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold text-blue-600" id="stat-docs">-</div>
                        <div class="text-gray-600 mt-2" data-i18n="stats.totalUploaded">Total Uploaded</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold text-green-600" id="stat-completed">-</div>
                        <div class="text-gray-600 mt-2" data-i18n="stats.completed">Completed</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold text-yellow-600" id="stat-processing">-</div>
                        <div class="text-gray-600 mt-2" data-i18n="stats.processing">Processing</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <div class="text-3xl font-bold text-red-600" id="stat-failed">-</div>
                        <div class="text-gray-600 mt-2" data-i18n="stats.failed">Failed</div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6 cursor-pointer hover:shadow-lg transition-shadow" onclick="checkOrphanDocuments()">
                        <div class="text-3xl font-bold text-orange-600" id="stat-orphans">?</div>
                        <div class="text-gray-600 mt-2" data-i18n="stats.orphans">Orphan Records</div>
                        <div class="text-xs text-gray-500 mt-1" data-i18n="stats.clickToCheck">Click to check</div>
                    </div>
                </div>
                
                <!-- Orphan Documents Panel -->
                <div id="orphan-panel" class="bg-white rounded-lg shadow p-6 mb-6 hidden">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold text-orange-700">
                            <i class="fas fa-exclamation-triangle mr-2"></i>
                            <span data-i18n="stats.orphanDocuments">Orphan Documents (ES only)</span>
                        </h3>
                        <div class="flex gap-2">
                            <button onclick="cleanupOrphanDocuments()" class="text-red-600 hover:text-red-800 text-sm font-medium px-3 py-1 border border-red-600 rounded hover:bg-red-50">
                                <i class="fas fa-trash mr-1"></i> <span data-i18n="stats.cleanupOrphans">Cleanup All</span>
                            </button>
                            <button onclick="document.getElementById('orphan-panel').classList.add('hidden')" class="text-gray-600 hover:text-gray-800 text-sm">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="text-sm text-gray-600 mb-4" data-i18n="stats.orphanDescription">
                        These records exist in Elasticsearch but their source files are missing. This may happen if documents were deleted while ES was offline.
                    </div>
                    <div id="orphan-list" class="space-y-2 max-h-96 overflow-y-auto"></div>
                </div>

                <!-- Document List -->
                <div class="bg-white rounded-lg shadow p-6 mb-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-lg font-semibold" data-i18n="stats.recentDocs">Recent Documents</h3>
                        <button onclick="deleteAllDocuments()" class="text-red-600 hover:text-red-800 text-sm font-medium">
                            <i class="fas fa-trash mr-1"></i> <span data-i18n="stats.clearAll">Clear All</span>
                        </button>
                    </div>
                    
                    <!-- Search and Filter Bar -->
                    <div class="mb-4 grid grid-cols-4 gap-3">
                        <div>
                            <input type="text" id="doc-search" 
                                   class="w-full px-3 py-2 border rounded-lg text-sm" 
                                   placeholder="ÊêúÁ¥¢ÊñáÊ°£ÂêçÁß∞..." 
                                   data-i18n-placeholder="stats.searchPlaceholder"
                                   oninput="filterDocuments()">
                        </div>
                        <div>
                            <select id="doc-category-filter" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm" 
                                    onchange="filterDocuments()">
                                <option value="">ÂÖ®ÈÉ®ÂàÜÁ±ª</option>
                            </select>
                        </div>
                        <div>
                            <select id="doc-status-filter" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm" 
                                    onchange="filterDocuments()">
                                <option value="" data-i18n="stats.allStatus">ÂÖ®ÈÉ®Áä∂ÊÄÅ</option>
                                <option value="completed" data-i18n="stats.completed">Â∑≤ÂÆåÊàê</option>
                                <option value="processing" data-i18n="stats.processing">Â§ÑÁêÜ‰∏≠</option>
                                <option value="failed" data-i18n="stats.failed">Â§±Ë¥•</option>
                            </select>
                        </div>
                        <div>
                            <select id="doc-date-filter" 
                                    class="w-full px-3 py-2 border rounded-lg text-sm" 
                                    onchange="filterDocuments()">
                                <option value="all" data-i18n="stats.allTime">ÂÖ®ÈÉ®Êó∂Èó¥</option>
                                <option value="today" data-i18n="stats.today">‰ªäÂ§©</option>
                                <option value="week" data-i18n="stats.thisWeek">Êú¨Âë®</option>
                                <option value="month" data-i18n="stats.thisMonth">Êú¨Êúà</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- Document List -->
                    <div id="documents-list" class="space-y-2 mb-4"></div>
                    
                    <!-- Pagination -->
                    <div class="flex justify-between items-center pt-4 border-t">
                        <div class="text-sm text-gray-600">
                            <span data-i18n="stats.showing">ÊòæÁ§∫</span>
                            <span id="doc-showing-start">0</span>-<span id="doc-showing-end">0</span>
                            <span data-i18n="stats.of">ÂÖ±</span>
                            <span id="doc-total-count">0</span>
                            <span data-i18n="stats.documents">‰∏™ÊñáÊ°£</span>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="previousPage()" 
                                    id="prev-page-btn"
                                    class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <i class="fas fa-chevron-left"></i>
                                <span class="ml-1" data-i18n="stats.previous">‰∏ä‰∏ÄÈ°µ</span>
                            </button>
                            <span class="px-3 py-1 text-sm text-gray-700">
                                <span data-i18n="stats.page">Á¨¨</span>
                                <span id="current-page">1</span>
                                <span data-i18n="stats.pageOf">/</span>
                                <span id="total-pages">1</span>
                                <span data-i18n="stats.pageUnit">È°µ</span>
                            </span>
                            <button onclick="nextPage()" 
                                    id="next-page-btn"
                                    class="px-3 py-1 border rounded hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
                                    disabled>
                                <span class="mr-1" data-i18n="stats.next">‰∏ã‰∏ÄÈ°µ</span>
                                <i class="fas fa-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6">
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4" data-i18n="stats.topCategories">Top Categories</h3>
                        <div id="categories-list"></div>
                    </div>
                    <div class="bg-white rounded-lg shadow p-6">
                        <h3 class="text-lg font-semibold mb-4" data-i18n="stats.fileTypes">File Types</h3>
                        <div id="file-types-list"></div>
                    </div>
                </div>

                <button onclick="loadStats()" class="mt-6 bg-blue-600 text-white px-6 py-3 rounded-lg hover:bg-blue-700 transition-colors">
                    <i class="fas fa-sync-alt mr-2"></i> <span data-i18n="stats.refresh">Refresh Statistics</span>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Tab switching
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.add('hidden');
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active', 'bg-gray-800');
            });
            
            document.getElementById(`${tabName}-tab`).classList.remove('hidden');
            const btn = document.querySelector(`[data-tab="${tabName}"]`);
            if (btn) btn.classList.add('active', 'bg-gray-800');
            
            // Persist tab state
            localStorage.setItem('currentTab', tabName);
            
            if (tabName === 'stats') {
                loadStats();
            }
        }

        // Initialize tab from storage
        document.addEventListener('DOMContentLoaded', () => {
            const savedTab = localStorage.getItem('currentTab') || 'upload';
            showTab(savedTab);
        });

        // Drag and drop
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const selectedFilesDiv = document.getElementById('selected-files');
        const filesList = document.getElementById('files-list');

        dropZone.addEventListener('click', () => fileInput.click());

        // File input change event
        fileInput.addEventListener('change', () => {
            displaySelectedFiles();
        });

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
        });

        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('border-blue-500', 'bg-blue-50');
            fileInput.files = e.dataTransfer.files;
            displaySelectedFiles();
        });

        // Display selected files
        function displaySelectedFiles() {
            const files = fileInput.files;
            if (files.length === 0) {
                selectedFilesDiv.classList.add('hidden');
                return;
            }

            selectedFilesDiv.classList.remove('hidden');
            filesList.innerHTML = '';

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center justify-between p-3 bg-gray-50 rounded border';
                fileItem.innerHTML = `
                    <div class="flex items-center space-x-3">
                        <i class="fas fa-file text-blue-500"></i>
                        <div>
                            <div class="text-sm font-medium">${file.name}</div>
                            <div class="text-xs text-gray-500">${(file.size / 1024).toFixed(1)} KB</div>
                        </div>
                    </div>
                    <i class="fas fa-check-circle text-green-500"></i>
                `;
                filesList.appendChild(fileItem);
            }
        }

        // Upload files
        async function uploadFiles() {
            const files = fileInput.files;
            if (!files.length) {
                const msg = currentLang === 'zh' ? 'ËØ∑ÈÄâÊã©Ë¶Å‰∏ä‰º†ÁöÑÊñá‰ª∂' : 'Please select files to upload';
                alert(msg);
                return;
            }

            const category = document.getElementById('category').value;
            const author = document.getElementById('author').value;
            const tags = document.getElementById('tags').value;
            const description = document.getElementById('description').value;
            const ocrEngine = document.getElementById('ocr-engine').value;

            // Auto-detect file type and upload each file separately
            const uploadPromises = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const fileName = file.name.toLowerCase();
                
                // Validate file extension (ÊîØÊåÅ PDF, ZIP, JPG, JPEG, PNG, PPTX)
                const supportedExtensions = ['.pdf', '.zip', '.jpg', '.jpeg', '.png', '.pptx'];
                const isSupported = supportedExtensions.some(ext => fileName.endsWith(ext));
                
                if (!isSupported) {
                    const msg = currentLang === 'zh' 
                        ? `Ë∑≥Ëøá‰∏çÊîØÊåÅÁöÑÊñá‰ª∂: ${file.name} (ÊîØÊåÅ: PDF, ZIP, JPG, JPEG, PNG, PPTX)` 
                        : `Skipping unsupported file: ${file.name} (supported: PDF, ZIP, JPG, JPEG, PNG, PPTX)`;
                    console.warn(msg);
                    continue;
                }
                
                const formData = new FormData();
                formData.append('file', file);

            if (category) formData.append('category', category);
            if (author) formData.append('author', author);
            if (tags) formData.append('tags', tags);
            if (description) formData.append('description', description);
            if (ocrEngine) formData.append('ocr_engine', ocrEngine);

                uploadPromises.push({
                    file: file,
                    formData: formData
                });
            }
            
            if (uploadPromises.length === 0) {
                const msg = currentLang === 'zh' 
                    ? 'Ê≤°ÊúâÊúâÊïàÁöÑÊñá‰ª∂ÂèØ‰∏ä‰º† (ÊîØÊåÅ: PDF, ZIP, JPG, JPEG, PNG, PPTX)' 
                    : 'No valid files to upload (supported: PDF, ZIP, JPG, JPEG, PNG, PPTX)';
                alert(msg);
                return;
            }

            // Use single upload endpoint for all files
            const endpoint = '/upload';

            // Show upload status
            document.getElementById('upload-status').classList.remove('hidden');
            const uploadingTitle = currentLang === 'zh' ? 'Ê≠£Âú®‰∏ä‰º†Êñá‰ª∂...' : 'Uploading files...';
            const uploadingMsg = currentLang === 'zh' 
                ? `‰∏ä‰º†ÈòüÂàó: ${uploadPromises.length} ‰∏™Êñá‰ª∂` 
                : `Upload queue: ${uploadPromises.length} file(s)`;
                   
                   document.getElementById('status-content').innerHTML = `
                       <div class="flex items-center space-x-3 text-blue-600">
                           <i class="fas fa-spinner fa-spin text-2xl"></i>
                           <div>
                        <div class="font-medium">${uploadingTitle}</div>
                        <div class="text-sm text-gray-600">${uploadingMsg}</div>
                           </div>
                       </div>
                   `;

            // Upload files sequentially to avoid overwhelming the server
            let successCount = 0;
            let failCount = 0;
            let duplicateCount = 0;
            const uploadedDocs = [];
            
            for (let i = 0; i < uploadPromises.length; i++) {
                const {file, formData} = uploadPromises[i];
                
                try {
                    const progressMsg = currentLang === 'zh' 
                        ? `Ê≠£Âú®‰∏ä‰º† ${i + 1}/${uploadPromises.length}: ${file.name}` 
                        : `Uploading ${i + 1}/${uploadPromises.length}: ${file.name}`;
                    
                    document.getElementById('status-content').innerHTML = `
                        <div class="flex items-center space-x-3 text-blue-600">
                            <i class="fas fa-spinner fa-spin text-2xl"></i>
                            <div>
                                <div class="font-medium">${uploadingTitle}</div>
                                <div class="text-sm text-gray-600">${progressMsg}</div>
                            </div>
                        </div>
                    `;
                    
                    console.log('Uploading to:', endpoint, 'File:', file.name);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();
                    console.log('Upload result for', file.name, ':', result);
                    console.log('Response OK?:', response.ok, 'Result status:', result.status);
                
                       // Check both HTTP status AND result.status field
                       if (response.ok && result.status !== 'failed') {
                           // Check if duplicate
                           if (result.status === 'duplicate') {
                            console.log('Duplicate file detected:', file.name);
                            duplicateCount++;
                           } else if (result.status === 'processing') {
                            // Add to uploaded docs for progress tracking
                            uploadedDocs.push({
                                docId: result.document_id,
                                filename: result.filename || file.name
                            });
                            successCount++;
                           } else {
                            // Completed immediately
                            successCount++;
                        }
                    } else {
                        // Handle failed status
                        failCount++;
                        console.error('Upload failed for', file.name, ':', result.error || result.detail);
                    }
                } catch (error) {
                    console.error('Upload error for', file.name, ':', error);
                    alert(`Upload error: ${file.name} - ${error.message}`);
                    failCount++;
                }
            }
            
            // Clear file input and selected files display
            fileInput.value = '';
            selectedFilesDiv.classList.add('hidden');
            
            // Show final status
            if (uploadedDocs.length > 0) {
                // Start polling for all uploaded documents
                uploadedDocs.forEach(doc => {
                    startProgressPolling(doc.docId, doc.filename);
                });
                
                // üî• ÁõëÂê¨ÊâÄÊúâÊñáÊ°£ÂÆåÊàêÂêéÂà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                const checkAllCompleted = setInterval(() => {
                    // Ê£ÄÊü•ÊòØÂê¶ÊâÄÊúâ‰ªªÂä°ÈÉΩÂ∑≤ÂÆåÊàêÔºàÊ≤°ÊúâÊ≠£Âú®ËøêË°åÁöÑ intervalÔºâ
                    const runningTasks = Object.keys(progressIntervals).filter(id => progressIntervals[id] !== null);
                    if (runningTasks.length === 0) {
                        clearInterval(checkAllCompleted);
                        console.log('All document processing completed, refreshing stats...');
                        
                        // Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆÂíåÊñáÊ°£ÂàóË°®
                        const currentTab = document.querySelector('.tab-button.bg-blue-600, .tab-button.bg-gray-700');
                        if (currentTab && (currentTab.textContent.includes('Statistics') || currentTab.textContent.includes('ÁªüËÆ°'))) {
                            loadStats();
                            loadDocuments(true);
                        }
                    }
                }, 2000); // ÊØè2ÁßíÊ£ÄÊü•‰∏ÄÊ¨°
                
            } else if (successCount > 0 || duplicateCount > 0) {
                // All completed immediately
                const successTitle = currentLang === 'zh' ? '‰∏ä‰º†ÂÆåÊàêÔºÅ' : 'Upload Complete!';
                let successMsg = currentLang === 'zh' 
                    ? `ÊàêÂäü‰∏ä‰º† ${successCount} ‰∏™Êñá‰ª∂` 
                    : `Successfully uploaded ${successCount} file(s)`;
                
                if (duplicateCount > 0) {
                    successMsg += currentLang === 'zh'
                        ? ` (${duplicateCount} ‰∏™ÈáçÂ§çÊñá‰ª∂Â∑≤Ë∑≥Ëøá)`
                        : ` (${duplicateCount} duplicate file(s) skipped)`;
                }
                               
                               document.getElementById('status-content').innerHTML = `
                                   <div class="text-green-600">
                                       <div class="flex items-center space-x-2 mb-3">
                                           <i class="fas fa-check-circle text-2xl"></i>
                                           <div class="text-lg font-semibold">${successTitle}</div>
                                       </div>
                        <div class="mt-3 text-sm text-gray-700 bg-green-50 p-4 rounded">
                            ${successMsg}
                                       </div>
                                   </div>
                               `;
                
                // üî• Á´ãÂç≥Âà∑Êñ∞ÁªüËÆ°Êï∞ÊçÆ
                setTimeout(() => {
                    loadStats();
                    const currentTab = document.querySelector('.tab-button.bg-blue-600, .tab-button.bg-gray-700');
                    if (currentTab && (currentTab.textContent.includes('Statistics') || currentTab.textContent.includes('ÁªüËÆ°'))) {
                        loadDocuments(true);
                    }
                }, 1000);
                } else {
                // All failed
                const failTitle = currentLang === 'zh' ? '‚ùå ‰∏ä‰º†Â§±Ë¥•' : '‚ùå Upload Failed';
                const failMsg = currentLang === 'zh' 
                    ? `‰∏ä‰º†Â§±Ë¥•„ÄÇËØ∑Ê£ÄÊü•Êñá‰ª∂Ê†ºÂºèÂíåÁΩëÁªúËøûÊé•„ÄÇ` 
                    : `Upload failed. Please check file format and network connection.`;
                
                document.getElementById('status-content').innerHTML = `
                    <div class="text-red-600">
                        <div class="flex items-center space-x-2 mb-3">
                            <i class="fas fa-exclamation-circle text-2xl"></i>
                            <div class="text-lg font-semibold">${failTitle}</div>
                        </div>
                        <div class="mt-3 text-sm bg-red-50 p-4 rounded">
                            ${failMsg}
                        </div>
                    </div>
                `;
            }
        }

        // Progress polling - support multiple documents
        let progressIntervals = {};
        
        function startProgressPolling(docId, filename) {
            // If already polling this doc, skip
            if (progressIntervals[docId]) {
                return;
            }
            
            const processingTitle = currentLang === 'zh' ? 'Ê≠£Âú®Â§ÑÁêÜÊñáÊ°£...' : 'Processing Document...';
            const filenameLabel = currentLang === 'zh' ? 'Êñá‰ª∂Âêç' : 'Filename';
            
            // Create or get progress container
            let statusContent = document.getElementById('status-content');
            let progressContainer = document.getElementById(`progress-container-${docId}`);
            
            if (!progressContainer) {
                progressContainer = document.createElement('div');
                progressContainer.id = `progress-container-${docId}`;
                progressContainer.className = 'mb-4 border-b border-blue-200 pb-4 last:border-b-0';
                statusContent.appendChild(progressContainer);
            }
            
            // Initial progress display (without control buttons)
            progressContainer.innerHTML = `
                <div class="text-blue-600">
                    <div class="flex items-center space-x-2 mb-2">
                        <i id="task-status-icon-${docId}" class="fas fa-spinner fa-spin text-lg"></i>
                        <div class="font-medium text-sm">${filename}</div>
                    </div>
                    <div class="space-y-2 text-xs text-gray-700 bg-blue-50 p-3 rounded">
                        <div id="stage-info-${docId}" class="text-xs text-blue-700"></div>
                        <div>
                            <div class="flex justify-between mb-1">
                                <span id="progress-message-${docId}" class="text-xs font-medium">Starting...</span>
                                <span id="progress-percentage-${docId}" class="text-xs font-medium">0%</span>
                            </div>
                            <div class="w-full bg-gray-200 rounded-full h-2">
                                <div id="progress-bar-${docId}" class="bg-blue-600 h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="page-progress-${docId}" class="text-xs text-gray-600"></div>
                    </div>
                </div>
            `;
            
            // Poll progress every 2 seconds
            progressIntervals[docId] = setInterval(async () => {
                try {
                    const response = await fetch(`/documents/${docId}/progress?include_children=true`);
                    const progress = await response.json();
                    
                    // Update status icon
                    const statusIcon = document.getElementById(`task-status-icon-${docId}`);
                    if (statusIcon) {
                        if (progress.status === 'paused') {
                            statusIcon.className = 'fas fa-pause-circle text-lg';
                        } else if (progress.status === 'running') {
                            statusIcon.className = 'fas fa-spinner fa-spin text-lg';
                        }
                    }
                    
                    // Update progress bar
                    const percentage = progress.progress_percentage || 0;
                    const progressBar = document.getElementById(`progress-bar-${docId}`);
                    const progressPercentage = document.getElementById(`progress-percentage-${docId}`);
                    const progressMessage = document.getElementById(`progress-message-${docId}`);
                    
                    if (progressBar) progressBar.style.width = `${percentage}%`;
                    if (progressPercentage) progressPercentage.textContent = `${percentage}%`;
                    if (progressMessage) progressMessage.textContent = progress.message || progress.progress_message || 'Processing...';
                    
                    // Update stage info if available
                    const stageInfo = document.getElementById(`stage-info-${docId}`);
                    if (stageInfo && progress.stage) {
                        const stageLabel = currentLang === 'zh' ? 'Èò∂ÊÆµ' : 'Stage';
                        const stageNames = {
                            'initializing': currentLang === 'zh' ? 'ÂàùÂßãÂåñ' : 'Initializing',
                            'extracting_zip': currentLang === 'zh' ? 'Ëß£ÂéãZIP' : 'Extracting ZIP',
                            'ocr_processing': currentLang === 'zh' ? 'OCRÂ§ÑÁêÜ' : 'OCR Processing',
                            'vlm_extraction': currentLang === 'zh' ? 'VLMÊèêÂèñ' : 'VLM Extraction',
                            'indexing': currentLang === 'zh' ? 'Á¥¢Âºï‰∏≠' : 'Indexing',
                            'finalizing': currentLang === 'zh' ? 'ÂÆåÊàê‰∏≠' : 'Finalizing'
                        };
                        const stageDisplay = stageNames[progress.stage] || progress.stage;
                        stageInfo.textContent = `${stageLabel}: ${stageDisplay}`;
                    }
                    
                    // Update page progress
                    const pageProgress = document.getElementById(`page-progress-${docId}`);
                    if (pageProgress && progress.total_pages > 0) {
                        const pageProgressText = currentLang === 'zh' 
                            ? `È°µÈù¢ ${progress.processed_pages}/${progress.total_pages}`
                            : `Page ${progress.processed_pages}/${progress.total_pages}`;
                        pageProgress.textContent = pageProgressText;
                    }
                    
                    // Check if completed, failed, or cancelled
                    if (progress.status === 'completed') {
                        stopProgressPolling(docId);
                        const container = document.getElementById(`progress-container-${docId}`);
                        if (container) {
                            container.innerHTML = `
                            <div class="text-green-600">
                                    <div class="flex items-center space-x-2 text-sm">
                                        <i class="fas fa-check-circle"></i>
                                        <span class="font-medium">${filename}</span>
                                        <span class="text-xs">(${progress.total_pages || 0} ${currentLang === 'zh' ? 'È°µ' : 'pages'})</span>
                                </div>
                                </div>
                            `;
                        }
                        
                        // üî• Ëá™Âä®Âà∑Êñ∞ÊñáÊ°£ÂàóË°®ÔºàÂ¶ÇÊûúÂú® Statistics Ê†áÁ≠æÈ°µÔºâ
                        const currentTab = document.querySelector('.tab-button.bg-blue-600, .tab-button.bg-gray-700');
                        if (currentTab && currentTab.textContent.includes('Statistics') || currentTab.textContent.includes('ÁªüËÆ°')) {
                            console.log('Document processing completed, refreshing document list...');
                            loadDocuments(true); // ÈáçÊñ∞Âä†ËΩΩÊñáÊ°£ÂàóË°®
                        }
                    } else if (progress.status === 'cancelled') {
                        stopProgressPolling(docId);
                        const container = document.getElementById(`progress-container-${docId}`);
                        if (container) {
                            container.innerHTML = `
                                <div class="text-gray-600">
                                    <div class="flex items-center space-x-2 text-sm">
                                        <i class="fas fa-ban"></i>
                                        <span class="font-medium">${filename}</span>
                                        <span class="text-xs">(${currentLang === 'zh' ? 'Â∑≤ÂèñÊ∂à' : 'Cancelled'})</span>
                                </div>
                            </div>
                        `;
                        }
                    } else if (progress.status === 'failed') {
                        stopProgressPolling(docId);
                        const container = document.getElementById(`progress-container-${docId}`);
                        if (container) {
                            const errorMsg = progress.error_message || 'Unknown error';
                            container.innerHTML = `
                            <div class="text-red-600">
                                    <div class="flex items-center space-x-2 text-sm">
                                        <i class="fas fa-exclamation-circle"></i>
                                        <span class="font-medium">${filename}</span>
                                        <span class="text-xs">(${currentLang === 'zh' ? 'Â§±Ë¥•' : 'Failed'})</span>
                                </div>
                                    <div class="text-xs text-gray-600 mt-1">${errorMsg}</div>
                            </div>
                        `;
                        }
                    }
                } catch (error) {
                    console.error('Progress polling error:', error);
                    stopProgressPolling(docId);
                }
            }, 2000); // Poll every 2 seconds
        }
        
        function stopProgressPolling(docId) {
            if (progressIntervals[docId]) {
                clearInterval(progressIntervals[docId]);
                delete progressIntervals[docId];
            }
        }

        function displayZipChildren(children, parentDocId) {
            // ZIP details shown in Stats tab, simple summary in upload tab
            const pageProgress = document.getElementById(`page-progress-${parentDocId}`);
            if (!pageProgress) return;
            
            const completedCount = children.filter(c => c.status === 'completed').length;
            const totalCount = children.length;
            const processingCount = children.filter(c => c.status === 'processing' || c.status === 'running').length;
            const failedCount = children.filter(c => c.status === 'failed').length;
            const filesLabel = currentLang === 'zh' ? 'Êñá‰ª∂' : 'files';
            
            let statusText = `${completedCount}/${totalCount} ${filesLabel}`;
            if (processingCount > 0) {
                statusText += currentLang === 'zh' ? ` (${processingCount} Â§ÑÁêÜ‰∏≠)` : ` (${processingCount} processing)`;
            }
            if (failedCount > 0) {
                statusText += currentLang === 'zh' ? ` (${failedCount} Â§±Ë¥•)` : ` (${failedCount} failed)`;
            }
            
            pageProgress.textContent = statusText;
            return; // Don't show detailed children in upload tab
        }

        // Search
        async function performSearch() {
            const query = document.getElementById('search-query').value;
            if (!query) {
                const msg = currentLang === 'zh' ? 'ËØ∑ËæìÂÖ•ÊêúÁ¥¢Êü•ËØ¢' : 'Please enter a search query';
                alert(msg);
                return;
            }

            const k = parseInt(document.getElementById('search-k').value);
            const useHybrid = document.getElementById('use-hybrid').checked;
            const filterCategory = document.getElementById('filter-category').value;
            const filterAuthor = document.getElementById('filter-author').value;
            const filterType = document.getElementById('filter-type').value;

            const filters = {};
            if (filterCategory) filters.category = filterCategory;
            if (filterAuthor) filters.author = filterAuthor;
            if (filterType) filters.file_type = filterType;

            const searchingMsg = currentLang === 'zh' ? 'ÊêúÁ¥¢‰∏≠...' : 'Searching...';
            document.getElementById('search-results').innerHTML = `<div class="text-blue-600">${searchingMsg}</div>`;

            try {
                const response = await fetch('/search', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        query,
                        k,
                        filters: Object.keys(filters).length > 0 ? filters : null,
                        use_hybrid: useHybrid
                    })
                });

                const data = await response.json();
                console.log('=== Search Response ===');
                console.log('Total results:', data.total);
                console.log('First result:', data.results?.[0]);
                if (data.results?.[0]) {
                    console.log('Metadata:', data.results[0].metadata);
                    console.log('Pages data:', data.results[0].metadata?.pages_data);
                    console.log('OCR engine:', data.results[0].metadata?.ocr_engine);
                    console.log('Matched bboxes:', data.results[0].matched_bboxes);
                }
                
                // Store search results globally for bbox drawing
                window.searchResults = data.results || [];
                
                if (data.results && data.results.length > 0) {
                    const resultsHTML = data.results.map((result, index) => {
                        // Use highlighted text if available, otherwise use regular content
                        let displayText = '';
                        if (result.highlighted) {
                            displayText = result.highlighted;
                        } else if (result.content) {
                            displayText = result.content.substring(0, 300) + '...';
                        } else if (result.text) {
                            displayText = result.text.substring(0, 300) + '...';
                        }
                        
                        // Build image preview section
                        let imageSection = '';
                        const pages = result.metadata?.pages_data;
                        const ocrEngine = result.metadata?.ocr_engine || 'standard';
                        const pageNumber = result.metadata?.page_number || 1;
                        
                        console.log(`Result ${index}: pages_data =`, pages, 'ocr_engine =', ocrEngine);
                        
                        if (pages && Array.isArray(pages) && pages.length > 0) {
                            // Find the EXACT page that matches (not always first page!)
                            const matchedPageNum = result.metadata?.page_number || result.metadata?.page || 1;
                            let matchedPage = pages.find(p => p.page_num === matchedPageNum);
                            
                            // Fallback to first page if exact match not found
                            if (!matchedPage && pages.length > 0) {
                                matchedPage = pages[0];
                                console.warn(`  Page ${matchedPageNum} not found, using page ${matchedPage.page_num} as fallback`);
                            }
                            
                            const resultId = `result-${index}`;
                            
                            console.log(`  Building image section for result ${index}:`, {
                                requested_page: matchedPageNum,
                                actual_page: matchedPage?.page_num,
                                image_path: matchedPage?.image_path,
                                visualized_path: matchedPage?.visualized_path,
                                text_count: matchedPage?.text_count
                            });
                            
                            const pageLabel = currentLang === 'zh' ? 'È°µ' : 'Page';
                            const engineLabel = currentLang === 'zh' ? 'ÂºïÊìé' : 'Engine';
                            const textsDetectedLabel = currentLang === 'zh' ? '‰∏™ÊñáÊú¨Ê£ÄÊµã' : 'texts detected';
                            const showImagesLabel = currentLang === 'zh' ? 'ÊòæÁ§∫ÂõæÁâá' : 'Show Images';
                            
                            imageSection = `
                                <div class="mt-4 border-t pt-4">
                                    <div class="flex justify-between items-center mb-2">
                                        <div class="text-sm font-medium text-gray-700">
                                            üìÑ <span class="font-bold text-blue-600">${pageLabel} ${matchedPage.page_num || matchedPageNum}</span> / ${pages.length} | 
                                            ${engineLabel}: <span class="font-bold text-green-600">${ocrEngine.toUpperCase()}</span> | 
                                            ${matchedPage.text_count || 0} ${textsDetectedLabel}
                                        </div>
                                        <div class="flex gap-2">
                                            <button onclick="toggleImage('${resultId}')" class="px-3 py-1 bg-blue-500 text-white hover:bg-blue-600 rounded text-sm transition-colors">
                                                <i class="fas fa-eye"></i> ${showImagesLabel}
                                            </button>
                                        </div>
                                    </div>
                                    <div id="${resultId}-images" class="hidden mt-3 grid grid-cols-2 gap-3">
                                        <div class="bg-gray-50 p-2 rounded">
                                            <div class="text-xs font-semibold text-gray-700 mb-2">üì∑ ${currentLang === 'zh' ? 'ÂéüÂßãÈ°µÈù¢ÔºàÂ∏¶ÂåπÈÖçÊ†áËÆ∞Ôºâ' : 'Original Page (with matches)'}</div>
                                            <div class="relative" style="width: 100%;">
                                                <canvas id="${resultId}-canvas" 
                                                        class="w-full border-2 border-gray-300 rounded cursor-pointer hover:border-red-500 hover:shadow-lg transition-all"
                                                        onclick="openFullView('${matchedPage.image_path}')"
                                                        data-image-path="${matchedPage.image_path}"
                                                        data-result-index="${index}"
                                                        style="max-width: 100%; height: auto;">
                                                </canvas>
                                            </div>
                                        </div>
                                        <div class="bg-gray-50 p-2 rounded">
                                            <div class="text-xs font-semibold text-gray-700 mb-2">üîç ${currentLang === 'zh' ? 'OCR Ê£ÄÊµã' : 'OCR Detection'}</div>
                                            <img src="${matchedPage.visualized_path}" 
                                                 alt="OCR Visualization Page ${matchedPage.page_num}" 
                                                 class="w-full border-2 border-gray-300 rounded cursor-pointer hover:border-green-500 hover:shadow-lg transition-all" 
                                                 onclick="openFullView('${matchedPage.visualized_path}')"
                                                 onerror="this.onerror=null; this.src='data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22300%22><text x=%2250%%22 y=%2250%%22 text-anchor=%22middle%22>${currentLang === 'zh' ? 'ÂèØËßÜÂåñÊú™ÊâæÂà∞' : 'Visualization not found'}</text></svg>'; console.error('Failed to load visualization:', '${matchedPage.visualized_path}')">
                                        </div>
                                    </div>
                                    ${matchedPage.components && Array.isArray(matchedPage.components) && matchedPage.components.length > 0 ? `
                                        <div class="mt-3 p-2 bg-purple-50 rounded">
                                            <div class="flex gap-1 flex-wrap items-center">
                                                <span class="text-xs font-semibold text-purple-900">üîß ${currentLang === 'zh' ? 'ÁªÑ‰ª∂' : 'Components'}:</span>
                                                ${matchedPage.components.slice(0, 10).map(c => `<span class="px-2 py-1 bg-purple-200 text-purple-900 text-xs rounded font-mono">${c}</span>`).join('')}
                                                ${matchedPage.components.length > 10 ? `<span class="text-xs text-purple-700 font-semibold">+${matchedPage.components.length - 10} ${currentLang === 'zh' ? '‰∏™Êõ¥Â§ö' : 'more'}</span>` : ''}
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                            `;
                        } else {
                            console.log(`  No pages_data for result ${index}`);
                            // Â¶ÇÊûúÊ≤°Êúâ pages_dataÔºåÊòæÁ§∫ÊèêÁ§∫ÂíåËØ¶ÁªÜ‰ø°ÊÅØ
                            const noPreviewMsg = currentLang === 'zh' 
                                ? '‚ö†Ô∏è Êó†È°µÈù¢È¢ÑËßà'
                                : '‚ö†Ô∏è No page preview available';
                            const fileIssueMsg = currentLang === 'zh'
                                ? 'ÊñáÊ°£Êñá‰ª∂ÂèØËÉΩÂ∑≤Ë¢´Âà†Èô§ÊàñESÁ¥¢ÂºïÊï∞ÊçÆ‰∏çÂêåÊ≠•'
                                : 'Document file may be deleted or ES index data is out of sync';
                            const showDetailsLabel = currentLang === 'zh' ? 'Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ' : 'View Details';
                            const hideDetailsLabel = currentLang === 'zh' ? 'ÈöêËóèËØ¶ÁªÜ‰ø°ÊÅØ' : 'Hide Details';
                            const deleteFromESLabel = currentLang === 'zh' ? '‰ªé ES Âà†Èô§Ê≠§ËÆ∞ÂΩï' : 'Delete from ES';
                            const metadataLabel = currentLang === 'zh' ? 'ÂÖÉÊï∞ÊçÆ‰ø°ÊÅØ' : 'Metadata Information';
                            
                            // Format metadata for display
                            const metadataDisplay = Object.entries(result.metadata || {})
                                .map(([key, value]) => {
                                    let displayValue = value;
                                    if (Array.isArray(value)) {
                                        displayValue = value.join(', ');
                                    } else if (typeof value === 'object') {
                                        displayValue = JSON.stringify(value, null, 2);
                                    }
                                    return `<div class="flex py-1"><span class="font-semibold text-gray-700 w-32">${key}:</span><span class="text-gray-600">${displayValue}</span></div>`;
                                }).join('');
                            
                            imageSection = `
                                <div class="mt-4 border-t pt-4 bg-red-50 rounded-lg p-4">
                                    <div class="flex items-start gap-3">
                                        <div class="flex-1">
                                            <div class="text-sm font-semibold text-red-700 mb-1">
                                        ${noPreviewMsg}
                                            </div>
                                            <div class="text-xs text-gray-600 mb-3">
                                                ${fileIssueMsg}
                                            </div>
                                            
                                            <!-- Collapsible Details -->
                                            <div class="mb-2">
                                                <button onclick="toggleOrphanDetails('orphan-${index}')" 
                                                        class="text-xs text-blue-600 hover:text-blue-800 font-medium">
                                                    <i class="fas fa-chevron-down mr-1"></i>
                                                    <span id="orphan-${index}-toggle">${showDetailsLabel}</span>
                                                </button>
                                            </div>
                                            <div id="orphan-${index}-details" class="hidden mt-2 p-3 bg-white rounded border border-gray-200">
                                                <div class="text-xs font-semibold text-gray-700 mb-2">${metadataLabel}:</div>
                                                <div class="text-xs max-h-48 overflow-y-auto">
                                                    ${metadataDisplay || '<span class="text-gray-500">No metadata available</span>'}
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <!-- Delete Button -->
                                        <button onclick="deleteOrphanDocument('${result.id}', ${index})" 
                                                class="px-3 py-2 bg-red-600 text-white text-xs font-medium rounded hover:bg-red-700 transition-colors whitespace-nowrap">
                                            <i class="fas fa-trash mr-1"></i>
                                            ${deleteFromESLabel}
                                        </button>
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Extract matched bbox info
                        let locationInfo = '';
                        const matchedBboxes = result.matched_bboxes || [];
                        
                        if (matchedBboxes.length > 0) {
                            const matchesLabel = currentLang === 'zh' ? '‰∏™ÂåπÈÖç‰ΩçÁΩÆ' : 'matched locations';
                            const coordLabel = currentLang === 'zh' ? 'ÂùêÊ†á' : 'Coordinates';
                            const confLabel = currentLang === 'zh' ? 'ÁΩÆ‰ø°Â∫¶' : 'confidence';
                            
                            const bboxInfo = matchedBboxes.slice(0, 3).map((match, idx) => {
                                const coords = `[${match.bbox.map(n => Math.round(n)).join(', ')}]`;
                                const conf = `${(match.confidence * 100).toFixed(0)}%`;
                                return `<span class="inline-block mr-2 mb-1"><span class="font-bold text-red-600">${idx+1}.</span> ${match.text.substring(0, 15)}${match.text.length > 15 ? '...' : ''} <span class="text-gray-500">(${confLabel}: ${conf})</span></span>`;
                            }).join('');
                            
                            locationInfo = `
                                <div class="mt-2 p-2 bg-red-50 rounded border border-red-200">
                                    <div class="text-xs font-semibold text-red-700 mb-1">
                                        üéØ ${matchedBboxes.length} ${matchesLabel}
                                    </div>
                                    <div class="text-xs text-gray-700">
                                        ${bboxInfo}
                                        ${matchedBboxes.length > 3 ? `<span class="text-red-600 font-semibold">+${matchedBboxes.length - 3} more</span>` : ''}
                                    </div>
                                </div>
                            `;
                        }
                        
                        // Full content (collapsible)
                        const fullContent = result.content || result.text || displayText;
                        const isLongContent = fullContent.length > 500;
                        const contentId = `content-${index}`;
                        
                        const unknownDocLabel = currentLang === 'zh' ? 'Êú™Áü•ÊñáÊ°£' : 'Unknown Document';
                        const pageLabel2 = currentLang === 'zh' ? 'È°µ' : 'Page';
                        const relevanceLabel = currentLang === 'zh' ? 'Áõ∏ÂÖ≥Â∫¶' : 'Relevance';
                        const matchedContentLabel = currentLang === 'zh' ? 'ÂåπÈÖçÂÜÖÂÆπ' : 'Matched Content';
                        const showFullContentLabel = currentLang === 'zh' ? 'ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ' : 'Show Full Content';
                        const hideContentLabel = currentLang === 'zh' ? 'ÈöêËóèÂÜÖÂÆπ' : 'Hide Content';
                        
                        return `
                            <div class="bg-white rounded-lg shadow-lg hover:shadow-xl transition-shadow p-6 border-l-4 border-blue-500">
                                <!-- Header -->
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <div class="text-xl font-bold text-gray-900 mb-1">
                                            üìÑ ${result.metadata?.filename || unknownDocLabel}
                                        </div>
                                        <div class="flex items-center gap-3 text-sm text-gray-600">
                                            <span class="font-semibold">#${index + 1}</span>
                                            ${result.metadata?.page_number || result.metadata?.page ? 
                                                `<span>‚Ä¢ ${pageLabel2} <span class="font-bold text-blue-600">${result.metadata.page_number || result.metadata.page}</span></span>` : ''}
                                            ${result.metadata?.filepath ? 
                                                `<span class="truncate max-w-md" title="${result.metadata.filepath}">‚Ä¢ üìÅ ${result.metadata.filepath}</span>` : ''}
                                        </div>
                                    </div>
                                    ${result.score ? `
                                        <div class="text-right">
                                            <div class="text-xs text-gray-500">${relevanceLabel}</div>
                                            <div class="text-lg font-bold text-green-600">${(result.score * 100).toFixed(1)}%</div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                <!-- Content Preview with Highlight -->
                                <div class="mb-3">
                                    <div class="text-sm font-semibold text-gray-700 mb-2">üìù ${matchedContentLabel}:</div>
                                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded highlight-content">
                                        <div id="${contentId}-preview" class="text-gray-800 leading-relaxed ${isLongContent ? 'line-clamp-4' : ''}">
                                            ${displayText}
                                        </div>
                                        ${isLongContent ? `
                                            <div id="${contentId}-full" class="hidden text-gray-800 leading-relaxed mt-2 pt-2 border-t border-yellow-300">
                                                ${fullContent}
                                            </div>
                                            <button onclick="toggleContent('${contentId}')" 
                                                    class="mt-2 text-blue-600 hover:text-blue-800 text-sm font-medium">
                                                <span id="${contentId}-toggle-text">
                                                    <i class="fas fa-chevron-down"></i> ${showFullContentLabel}
                                                </span>
                                            </button>
                                        ` : ''}
                                    </div>
                                    ${locationInfo}
                                </div>
                                
                                <!-- Metadata Tags -->
                                <div class="flex gap-2 flex-wrap mb-3">
                                    ${result.metadata?.category ? `<span class="px-3 py-1 bg-blue-100 text-blue-800 text-xs font-semibold rounded-full">üìÇ ${result.metadata.category}</span>` : ''}
                                    ${result.metadata?.author ? `<span class="px-3 py-1 bg-green-100 text-green-800 text-xs font-semibold rounded-full">üë§ ${result.metadata.author}</span>` : ''}
                                    ${result.metadata?.file_type ? `<span class="px-3 py-1 bg-gray-100 text-gray-800 text-xs font-semibold rounded-full">üìé ${result.metadata.file_type.toUpperCase()}</span>` : ''}
                                    ${result.metadata?.extraction_method ? `<span class="px-3 py-1 bg-purple-100 text-purple-800 text-xs font-semibold rounded-full">‚öôÔ∏è ${result.metadata.extraction_method}</span>` : ''}
                                    ${result.metadata?.tags && Array.isArray(result.metadata.tags) ? result.metadata.tags.map(tag => `<span class="px-3 py-1 bg-yellow-100 text-yellow-800 text-xs font-semibold rounded-full">üè∑Ô∏è ${tag.trim()}</span>`).join('') : ''}
                                </div>
                                
                                ${imageSection}
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('search-results').innerHTML = resultsHTML;
                } else {
                    const noResultsMsg = currentLang === 'zh' ? 'Êú™ÊâæÂà∞ÁªìÊûú' : 'No results found';
                    document.getElementById('search-results').innerHTML = `<div class="text-gray-600">${noResultsMsg}</div>`;
                }
            } catch (error) {
                const errorLabel = currentLang === 'zh' ? 'ÈîôËØØ' : 'Error';
                document.getElementById('search-results').innerHTML = `<div class="text-red-600">${errorLabel}: ${error.message}</div>`;
            }
        }

        // Load statistics
        // Check for orphan documents in ES
        async function checkOrphanDocuments() {
            try {
                document.getElementById('stat-orphans').textContent = '...';
                
                const response = await fetch('/orphan-check');
                const result = await response.json();
                
                const orphanCount = result.total || 0;
                document.getElementById('stat-orphans').textContent = orphanCount;
                
                if (orphanCount > 0) {
                    // Show orphan panel
                    const panel = document.getElementById('orphan-panel');
                    panel.classList.remove('hidden');
                    
                    // Display orphan list
                    const orphanList = document.getElementById('orphan-list');
                    const orphanHTML = result.orphans.map((orphan, index) => `
                        <div class="p-3 bg-orange-50 rounded border border-orange-200 flex justify-between items-start">
                            <div class="flex-1">
                                <div class="font-semibold text-gray-900">üìÑ ${orphan.filename}</div>
                                <div class="text-xs text-gray-600 mt-1">
                                    <span class="mr-3"><strong>Doc ID:</strong> ${orphan.document_id}</span>
                                    <span class="mr-3"><strong>Checksum:</strong> ${orphan.checksum || 'N/A'}</span>
                                    <span class="mr-3"><strong>In DB:</strong> ${orphan.in_database ? '‚úÖ' : '‚ùå'}</span>
                                </div>
                                ${orphan.metadata.category ? `<div class="text-xs text-gray-600 mt-1"><strong>Category:</strong> ${orphan.metadata.category}</div>` : ''}
                                ${orphan.metadata.author ? `<div class="text-xs text-gray-600"><strong>Author:</strong> ${orphan.metadata.author}</div>` : ''}
                            </div>
                            <button onclick="deleteOrphanByDocId('${orphan.document_id}', ${index})" 
                                    class="ml-3 px-2 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `).join('');
                    
                    orphanList.innerHTML = orphanHTML || '<div class="text-gray-500 text-sm">No orphan documents found</div>';
                } else {
                    alert(currentLang === 'zh' ? '‚úÖ Êú™ÂèëÁé∞Â≠§Â≤õÊï∞ÊçÆËÆ∞ÂΩïÔºÅ' : '‚úÖ No orphan records found!');
                }
            } catch (error) {
                document.getElementById('stat-orphans').textContent = '?';
                alert(currentLang === 'zh' ? `Ê£ÄÊü•Â§±Ë¥•: ${error.message}` : `Check failed: ${error.message}`);
            }
        }
        
        // Cleanup all orphan documents
        async function cleanupOrphanDocuments() {
            const confirmMsg = currentLang === 'zh' 
                ? 'Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÊâÄÊúâÂ≠§Â≤õÊï∞ÊçÆËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ' 
                : 'Are you sure you want to cleanup all orphan records? This action cannot be undone.';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch('/orphan-cleanup', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const successMsg = currentLang === 'zh' 
                        ? `ÊàêÂäüÊ∏ÖÁêÜ ${result.deleted_count} Êù°Â≠§Â≤õÊï∞ÊçÆÔºÅ` 
                        : `Successfully cleaned up ${result.deleted_count} orphan records!`;
                    alert(successMsg);
                    
                    // Refresh stats and hide panel
                    document.getElementById('orphan-panel').classList.add('hidden');
                    document.getElementById('stat-orphans').textContent = '0';
                    loadStats();
                } else {
                    throw new Error(result.message || 'Cleanup failed');
                }
            } catch (error) {
                alert(currentLang === 'zh' ? `Ê∏ÖÁêÜÂ§±Ë¥•: ${error.message}` : `Cleanup failed: ${error.message}`);
            }
        }
        
        // Delete single orphan by document_id
        async function deleteOrphanByDocId(docId, index) {
            try {
                const response = await fetch('/orphan-cleanup', {
                    method: 'DELETE',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({document_ids: [docId]})
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    // Remove from UI
                    const orphanList = document.getElementById('orphan-list');
                    const orphanItem = orphanList.children[index];
                    if (orphanItem) {
                        orphanItem.remove();
                    }
                    
                    // Update count
                    const currentCount = parseInt(document.getElementById('stat-orphans').textContent) || 0;
                    document.getElementById('stat-orphans').textContent = Math.max(0, currentCount - 1);
                    
                    // Hide panel if no more orphans
                    if (orphanList.children.length === 0) {
                        document.getElementById('orphan-panel').classList.add('hidden');
                    }
                } else {
                    throw new Error(result.message || 'Delete failed');
                }
            } catch (error) {
                alert(currentLang === 'zh' ? `Âà†Èô§Â§±Ë¥•: ${error.message}` : `Delete failed: ${error.message}`);
            }
        }

        async function loadStats() {
            try {
                const response = await fetch('/stats');
                const stats = await response.json();

                // ES Index Status
                if (stats.index) {
                    document.getElementById('es-index-name').textContent = stats.index.name || '-';
                    const status = stats.index.status || 'unknown';
                    const statusEl = document.getElementById('es-index-status');
                    statusEl.textContent = status;
                    statusEl.className = 'text-lg font-semibold ' + 
                        (status === 'green' ? 'text-green-600' : 
                         status === 'not_created' ? 'text-gray-600' : 'text-yellow-600');
                    document.getElementById('es-doc-count').textContent = stats.index.document_count || 0;
                }

                // Database stats
                if (stats.database) {
                    document.getElementById('stat-docs').textContent = stats.database.total || 0;
                    document.getElementById('stat-completed').textContent = stats.database.completed || 0;
                    document.getElementById('stat-processing').textContent = stats.database.processing || 0;
                    document.getElementById('stat-failed').textContent = stats.database.failed || 0;
                }

                const categoriesHTML = stats.categories?.map(cat => `
                    <div class="flex justify-between items-center py-2 border-b">
                        <span>${cat.name}</span>
                        <span class="font-semibold">${cat.count}</span>
                    </div>
                `).join('') || '<div class="text-gray-500">No data</div>';

                const fileTypesHTML = stats.file_types?.map(type => `
                    <div class="flex justify-between items-center py-2 border-b">
                        <span>${type.name}</span>
                        <span class="font-semibold">${type.count}</span>
                    </div>
                `).join('') || '<div class="text-gray-500">No data</div>';

                document.getElementById('categories-list').innerHTML = categoriesHTML;
                document.getElementById('file-types-list').innerHTML = fileTypesHTML;

                // Load documents list
                await loadDocuments();
            } catch (error) {
                console.error('Failed to load statistics:', error);
            }
        }

        // Load documents list with pagination and filtering
        let documentsPollingIntervalId = null;
        let allDocuments = []; // Store all documents for client-side filtering
        let filteredDocuments = []; // Store filtered documents
        let currentPageNum = 1;
        const docsPerPage = 10;
        
        async function loadDocuments(reload = true) {
            try {
                if (reload) {
                    // Fetch all documents from server
                    const response = await fetch('/documents?limit=1000');
                const data = await response.json();
                    allDocuments = data.documents || [];
                    
                    // Populate category filter
                    populateCategoryFilter();
                }
                
                // Apply filters
                filterDocuments();
                
            } catch (error) {
                console.error('Failed to load documents:', error);
            }
        }
        
        function populateCategoryFilter() {
            const categories = new Set();
            allDocuments.forEach(doc => {
                if (doc.category) {
                    categories.add(doc.category);
                }
            });
            
            const categoryFilter = document.getElementById('doc-category-filter');
            const currentValue = categoryFilter.value;
            
            // Keep first option (ÂÖ®ÈÉ®ÂàÜÁ±ª)
            const allCategoryText = currentLang === 'zh' ? 'ÂÖ®ÈÉ®ÂàÜÁ±ª' : 'All Categories';
            categoryFilter.innerHTML = `<option value="">${allCategoryText}</option>`;
            
            Array.from(categories).sort().forEach(cat => {
                const option = document.createElement('option');
                option.value = cat;
                option.textContent = cat;
                categoryFilter.appendChild(option);
            });
            
            // Restore previous selection
            categoryFilter.value = currentValue;
        }
        
        function filterDocuments() {
            const searchTerm = document.getElementById('doc-search').value.toLowerCase();
            const categoryFilter = document.getElementById('doc-category-filter').value;
            const statusFilter = document.getElementById('doc-status-filter').value;
            const dateFilter = document.getElementById('doc-date-filter').value;
            
            // Get date range
            const now = new Date();
            let dateStart = null;
            if (dateFilter === 'today') {
                dateStart = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            } else if (dateFilter === 'week') {
                dateStart = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            } else if (dateFilter === 'month') {
                dateStart = new Date(now.getFullYear(), now.getMonth(), 1);
            }
            
            // Apply filters
            filteredDocuments = allDocuments.filter(doc => {
                // Search filter (filename)
                if (searchTerm && !doc.filename.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // Category filter
                if (categoryFilter && doc.category !== categoryFilter) {
                    return false;
                }
                
                // Status filter
                if (statusFilter && doc.status !== statusFilter) {
                    return false;
                }
                
                // Date filter
                if (dateStart && doc.created_at) {
                    const docDate = new Date(doc.created_at);
                    if (docDate < dateStart) {
                        return false;
                    }
                }
                
                return true;
            });
            
            // Reset to first page
            currentPageNum = 1;
            
            // Display documents
            displayDocuments();
        }
        
        function displayDocuments() {
            const start = (currentPageNum - 1) * docsPerPage;
            const end = start + docsPerPage;
            const pageDocuments = filteredDocuments.slice(start, end);
            
            if (pageDocuments.length > 0) {
                const data = {documents: pageDocuments};

                const docsHTML = pageDocuments.map(doc => {
                        const statusColor = 
                            doc.status === 'completed' ? 'bg-green-100 text-green-800' :
                            doc.status === 'failed' ? 'bg-red-100 text-red-800' :
                            doc.status === 'processing' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800';
                        
                        // Build progress bar for processing documents
                        let progressBar = '';
                        if (doc.status === 'processing') {
                            const percentage = doc.progress_percentage || 0;
                            const progressMsg = doc.progress_message || (currentLang === 'zh' ? 'Â§ÑÁêÜ‰∏≠...' : 'Processing...');
                            const pageInfo = doc.total_pages > 0 ? 
                                (currentLang === 'zh' ? `${doc.processed_pages}/${doc.total_pages} È°µ` : `${doc.processed_pages}/${doc.total_pages} pages`) : '';
                            
                            progressBar = `
                                <div class="mt-2">
                                    <div class="flex justify-between items-center mb-1">
                                        <span class="text-xs text-gray-600">${progressMsg}</span>
                                        <span class="text-xs font-medium text-blue-600">${percentage}%</span>
                                    </div>
                                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                                        <div class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: ${percentage}%"></div>
                                    </div>
                                    ${pageInfo ? `<div class="text-xs text-gray-500 mt-1">${pageInfo}</div>` : ''}
                                </div>
                            `;
                        }
                        
                        return `
                            <div class="py-4 px-4 border-b border-slate-100 hover:bg-slate-50 transition-colors last:border-b-0" id="doc-${doc.id}">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <div class="flex items-center space-x-2">
                                            <i class="fas fa-file-alt text-slate-400"></i>
                                            <div class="font-medium text-slate-900">${doc.filename}</div>
                                        </div>
                                        <div class="text-xs text-slate-500 mt-1 ml-6">
                                            ${doc.file_type} ‚Ä¢ ${(doc.file_size / 1024).toFixed(1)} KB
                                            ${doc.num_chunks ? ` ‚Ä¢ ${doc.num_chunks} chunks` : ''}
                                        </div>
                                        ${progressBar}
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <span class="px-2.5 py-0.5 rounded-full text-xs font-medium ${statusColor}">${doc.status}</span>
                                        <button onclick="deleteDocument(${doc.id})" class="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-full transition-colors" title="${currentLang === 'zh' ? 'Âà†Èô§' : 'Delete'}">
                                            <i class="fas fa-trash-alt"></i>
                                        </button>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                    
                    document.getElementById('documents-list').innerHTML = docsHTML;
                    
                    // Start polling if there are processing documents
                const hasProcessing = pageDocuments.some(doc => doc.status === 'processing');
                    if (hasProcessing) {
                        startDocumentsPolling();
                    } else {
                        stopDocumentsPolling();
                    }
                } else {
                const noDocsMsg = currentLang === 'zh' ? 'Ê≤°ÊúâÊâæÂà∞ÂåπÈÖçÁöÑÊñáÊ°£' : 'No documents found';
                    document.getElementById('documents-list').innerHTML = `<div class="text-gray-500 text-center py-4">${noDocsMsg}</div>`;
                    stopDocumentsPolling();
                }
            
            // Update pagination info
            updatePaginationInfo();
        }
        
        function updatePaginationInfo() {
            const totalDocs = filteredDocuments.length;
            const totalPages = Math.ceil(totalDocs / docsPerPage);
            const start = totalDocs === 0 ? 0 : ((currentPageNum - 1) * docsPerPage + 1);
            const end = Math.min(currentPageNum * docsPerPage, totalDocs);
            
            document.getElementById('doc-showing-start').textContent = start;
            document.getElementById('doc-showing-end').textContent = end;
            document.getElementById('doc-total-count').textContent = totalDocs;
            document.getElementById('current-page').textContent = totalPages === 0 ? 0 : currentPageNum;
            document.getElementById('total-pages').textContent = Math.max(1, totalPages);
            
            // Enable/disable pagination buttons
            const prevBtn = document.getElementById('prev-page-btn');
            const nextBtn = document.getElementById('next-page-btn');
            
            prevBtn.disabled = currentPageNum <= 1;
            nextBtn.disabled = currentPageNum >= totalPages || totalPages === 0;
        }
        
        function previousPage() {
            if (currentPageNum > 1) {
                currentPageNum--;
                displayDocuments();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredDocuments.length / docsPerPage);
            if (currentPageNum < totalPages) {
                currentPageNum++;
                displayDocuments();
            }
        }
        
        function startDocumentsPolling() {
            if (documentsPollingIntervalId) return; // Already polling
            
            documentsPollingIntervalId = setInterval(() => {
                loadDocuments(true); // Reload documents list from server
            }, 3000); // Poll every 3 seconds
        }
        
        function stopDocumentsPolling() {
            if (documentsPollingIntervalId) {
                clearInterval(documentsPollingIntervalId);
                documentsPollingIntervalId = null;
            }
        }

        // Delete single document
        async function deleteDocument(docId) {
            const msg = currentLang === 'zh' ? 'Á°ÆÂÆöË¶ÅÂà†Èô§Ëøô‰∏™ÊñáÊ°£ÂêóÔºü' : 'Are you sure you want to delete this document?';
            if (!confirm(msg)) {
                return;
            }

            try {
                const response = await fetch(`/documents/${docId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadStats();  // Reload stats and documents
                } else {
                    const error = await response.json();
                    const errMsg = currentLang === 'zh' ? 'Âà†Èô§Â§±Ë¥•: ' : 'Delete failed: ';
                    alert(errMsg + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete failed:', error);
                const errMsg = currentLang === 'zh' ? 'Âà†Èô§Â§±Ë¥•: ' : 'Delete failed: ';
                alert(errMsg + error.message);
            }
        }

        // Delete all documents
        async function deleteAllDocuments() {
            const msg = currentLang === 'zh' ? 'Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÊñáÊ°£ËÆ∞ÂΩïÂêóÔºüËøô‰∏™Êìç‰Ωú‰∏çÂèØÊÅ¢Â§çÔºÅ' : 'Are you sure you want to clear all documents? This action cannot be undone!';
            if (!confirm(msg)) {
                return;
            }

            try {
                const response = await fetch('/documents', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    await loadStats();  // Reload stats and documents
                    const successMsg = currentLang === 'zh' ? 'ÊâÄÊúâÊñáÊ°£Â∑≤Ê∏ÖÁ©∫' : 'All documents cleared';
                    alert(successMsg);
                } else {
                    const error = await response.json();
                    const errMsg = currentLang === 'zh' ? 'Ê∏ÖÁ©∫Â§±Ë¥•: ' : 'Clear failed: ';
                    alert(errMsg + (error.detail || 'Unknown error'));
                }
            } catch (error) {
                console.error('Delete all failed:', error);
                const errMsg = currentLang === 'zh' ? 'Ê∏ÖÁ©∫Â§±Ë¥•: ' : 'Clear failed: ';
                alert(errMsg + error.message);
            }
        }

        // Search on Enter
        document.getElementById('search-query').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        // ========== i18n Support ==========
        const translations = {
                zh: {
                    app: {
                        title: 'NewRAG',
                    language: 'ËØ≠Ë®Ä'
                },
                nav: {
                    upload: '‰∏ä‰º†',
                    search: 'ÊêúÁ¥¢',
                    stats: 'ÁªüËÆ°'
                },
                upload: {
                    title: '‰∏ä‰º†ÊñáÊ°£',
                    dragDrop: 'ÊãñÊîæÊñá‰ª∂Âà∞ËøôÈáå',
                    clickBrowse: 'ÊàñÁÇπÂáªÊµèËßà',
                    autoDetect: 'ÊîØÊåÅ PDF„ÄÅZIP„ÄÅJPG/JPEG„ÄÅPNG„ÄÅPPTX„ÄÇZIP ÂéãÁº©ÂåÖÂ∞ÜËá™Âä®Ëß£Âéã„ÄÇ',
                    selectedFiles: 'Â∑≤ÈÄâÊã©ÁöÑÊñá‰ª∂Ôºö',
                    category: 'ÂàÜÁ±ª',
                    categoryPlaceholder: '‰æãÂ¶ÇÔºöincident, log, alert',
                    author: '‰ΩúËÄÖ',
                    authorPlaceholder: 'ÊÇ®ÁöÑÂêçÂ≠ó',
                    tags: 'Ê†áÁ≠æÔºàÈÄóÂè∑ÂàÜÈöîÔºâ',
                    tagsPlaceholder: 'security, ops, monitoring',
                    description: 'ÊèèËø∞',
                    descriptionPlaceholder: 'ÂèØÈÄâÊèèËø∞',
                    ocrEngine: 'OCR ÂºïÊìé',
                    button: '‰∏ä‰º†Âπ∂Â§ÑÁêÜ',
                    status: 'Â§ÑÁêÜÁä∂ÊÄÅ'
                },
                search: {
                    title: 'ÊêúÁ¥¢ÊñáÊ°£',
                    queryPlaceholder: 'ËæìÂÖ•ÊÇ®ÁöÑÊêúÁ¥¢Êü•ËØ¢...',
                    button: 'ÊêúÁ¥¢',
                    categoryFilter: 'ÂàÜÁ±ªËøáÊª§',
                    authorFilter: '‰ΩúËÄÖËøáÊª§',
                    typeFilter: 'Êñá‰ª∂Á±ªÂûãËøáÊª§',
                    optional: 'ÂèØÈÄâ',
                    results: 'ÁªìÊûúÊï∞',
                    hybrid: '‰ΩøÁî®Ê∑∑ÂêàÊêúÁ¥¢ÔºàÂêëÈáè + BM25Ôºâ',
                    showImage: 'ÊòæÁ§∫ÂõæÁâá'
                },
                stats: {
                    title: 'Á≥ªÁªüÁªüËÆ°',
                    esIndexStatus: 'Elasticsearch Á¥¢ÂºïÁä∂ÊÄÅ',
                    indexName: 'Á¥¢ÂºïÂêçÁß∞',
                    status: 'Áä∂ÊÄÅ',
                    docCount: 'ÊñáÊ°£Êï∞Èáè',
                    totalUploaded: 'ÊÄª‰∏ä‰º†',
                    completed: 'Â∑≤ÂÆåÊàê',
                    processing: 'Â§ÑÁêÜ‰∏≠',
                    orphans: 'Â≠§Â≤õÊï∞ÊçÆ',
                    clickToCheck: 'ÁÇπÂáªÊ£ÄÊü•',
                    orphanDocuments: 'Â≠§Â≤õÊñáÊ°£Ôºà‰ªÖESÔºâ',
                    cleanupOrphans: 'Ê∏ÖÁêÜÂÖ®ÈÉ®',
                    orphanDescription: 'Ëøô‰∫õËÆ∞ÂΩïÂ≠òÂú®‰∫é Elasticsearch ‰∏≠Ôºå‰ΩÜÊ∫êÊñá‰ª∂Â∑≤‰∏¢Â§±„ÄÇËøôÂèØËÉΩÂèëÁîüÂú® ES Á¶ªÁ∫øÊó∂Âà†Èô§‰∫ÜÊñáÊ°£„ÄÇ',
                    failed: 'Â§±Ë¥•',
                    recentDocs: 'ÊúÄËøëÊñáÊ°£',
                    clearAll: 'Ê∏ÖÁ©∫ÂÖ®ÈÉ®',
                    searchPlaceholder: 'ÊêúÁ¥¢ÊñáÊ°£ÂêçÁß∞...',
                    allStatus: 'ÂÖ®ÈÉ®Áä∂ÊÄÅ',
                    allTime: 'ÂÖ®ÈÉ®Êó∂Èó¥',
                    today: '‰ªäÂ§©',
                    thisWeek: 'Êú¨Âë®',
                    thisMonth: 'Êú¨Êúà',
                    showing: 'ÊòæÁ§∫',
                    of: 'ÂÖ±',
                    documents: '‰∏™ÊñáÊ°£',
                    previous: '‰∏ä‰∏ÄÈ°µ',
                    next: '‰∏ã‰∏ÄÈ°µ',
                    page: 'Á¨¨',
                    pageOf: '/',
                    pageUnit: 'È°µ',
                    topCategories: 'ÁÉ≠Èó®ÂàÜÁ±ª',
                    fileTypes: 'Êñá‰ª∂Á±ªÂûã',
                    refresh: 'Âà∑Êñ∞ÁªüËÆ°'
                }
            },
                en: {
                    app: {
                        title: 'NewRAG',
                    language: 'Language'
                },
                nav: {
                    upload: 'Upload',
                    search: 'Search',
                    stats: 'Statistics'
                },
                upload: {
                    title: 'Upload Documents',
                    dragDrop: 'Drag & drop files here',
                    clickBrowse: 'or click to browse',
                    autoDetect: 'Supports PDF, ZIP, JPG/JPEG, PNG, PPTX. ZIP archives will be extracted automatically.',
                    selectedFiles: 'Selected Files:',
                    category: 'Category',
                    categoryPlaceholder: 'e.g., incident, log, alert',
                    author: 'Author',
                    authorPlaceholder: 'Your name',
                    tags: 'Tags (comma-separated)',
                    tagsPlaceholder: 'security, ops, monitoring',
                    description: 'Description',
                    descriptionPlaceholder: 'Optional description',
                    ocrEngine: 'OCR Engine',
                    button: 'Upload & Process',
                    status: 'Processing Status'
                },
                search: {
                    title: 'Search Documents',
                    queryPlaceholder: 'Enter your search query...',
                    button: 'Search',
                    categoryFilter: 'Category Filter',
                    authorFilter: 'Author Filter',
                    typeFilter: 'File Type Filter',
                    optional: 'Optional',
                    results: 'Results',
                    hybrid: 'Use Hybrid Search (Vector + BM25)',
                    showImage: 'Show'
                },
                stats: {
                    title: 'System Statistics',
                    esIndexStatus: 'Elasticsearch Index Status',
                    indexName: 'Index Name',
                    status: 'Status',
                    docCount: 'Document Count',
                    totalUploaded: 'Total Uploaded',
                    completed: 'Completed',
                    processing: 'Processing',
                    orphans: 'Orphan Records',
                    clickToCheck: 'Click to check',
                    orphanDocuments: 'Orphan Documents (ES only)',
                    cleanupOrphans: 'Cleanup All',
                    orphanDescription: 'These records exist in Elasticsearch but their source files are missing. This may happen if documents were deleted while ES was offline.',
                    failed: 'Failed',
                    recentDocs: 'Recent Documents',
                    clearAll: 'Clear All',
                    searchPlaceholder: 'Search documents...',
                    allStatus: 'All Status',
                    allTime: 'All Time',
                    today: 'Today',
                    thisWeek: 'This Week',
                    thisMonth: 'This Month',
                    showing: 'Showing',
                    of: 'of',
                    documents: 'documents',
                    previous: 'Previous',
                    next: 'Next',
                    page: 'Page',
                    pageOf: 'of',
                    pageUnit: '',
                    topCategories: 'Top Categories',
                    fileTypes: 'File Types',
                    refresh: 'Refresh Statistics'
                }
            }
        };

        let currentLang = localStorage.getItem('language') || 'zh';

        function switchLanguage(lang) {
            currentLang = lang;
            localStorage.setItem('language', lang);
            document.documentElement.lang = lang === 'zh' ? 'zh-CN' : 'en';
            
            // Update flag opacity
            document.getElementById('lang-zh').style.opacity = lang === 'zh' ? '1' : '0.5';
            document.getElementById('lang-en').style.opacity = lang === 'en' ? '1' : '0.5';
            
            // Update all i18n elements
            updateTranslations();
        }

        function updateTranslations() {
            const t = translations[currentLang];
            
            // Update text content
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                const keys = key.split('.');
                let value = t;
                
                for (const k of keys) {
                    value = value?.[k];
                }
                
                if (value) {
                    el.textContent = value;
                }
            });
            
            // Update placeholders
            document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
                const key = el.getAttribute('data-i18n-placeholder');
                const keys = key.split('.');
                let value = t;
                
                for (const k of keys) {
                    value = value?.[k];
                }
                
                if (value) {
                    el.placeholder = value;
                }
            });
        }

        // Initialize language on page load
        document.addEventListener('DOMContentLoaded', () => {
            switchLanguage(currentLang);
        });

        // Toggle image visibility and draw matched bboxes on canvas
        function toggleImage(resultId) {
            const imageDiv = document.getElementById(`${resultId}-images`);
            if (imageDiv) {
                const wasHidden = imageDiv.classList.contains('hidden');
                imageDiv.classList.toggle('hidden');
                
                // If we're showing the image for the first time, draw bboxes
                if (wasHidden) {
                    const canvas = document.getElementById(`${resultId}-canvas`);
                    if (canvas && !canvas.dataset.drawn) {
                        const resultIndex = parseInt(canvas.dataset.resultIndex);
                        drawMatchedBboxes(resultId, resultIndex);
                        canvas.dataset.drawn = 'true';
                    }
                }
            }
        }
        
        // Draw matched bboxes on canvas (ÊñπÊ°àD: Áü©ÂΩ¢Ê°Ü + ÁÆ≠Â§¥ + Â∫èÂè∑)
        async function drawMatchedBboxes(resultId, resultIndex) {
            const canvas = document.getElementById(`${resultId}-canvas`);
            if (!canvas) {
                console.warn('Canvas not found:', resultId);
                return;
            }
            
            const imagePath = canvas.dataset.imagePath;
            const ctx = canvas.getContext('2d');
            
            // Load the image
            const img = new Image();
            img.onload = function() {
                // Set canvas size to match image
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw the image
                ctx.drawImage(img, 0, 0);
                
                // Get matched bboxes from global search results
                if (window.searchResults && window.searchResults[resultIndex]) {
                    const result = window.searchResults[resultIndex];
                    const matchedBboxes = result.matched_bboxes || [];
                    
                    console.log(`Drawing ${matchedBboxes.length} matched bboxes for result ${resultIndex}`);
                    
                    if (matchedBboxes.length === 0) {
                        console.log('No matched bboxes found');
                        return;
                    }
                    
                    // Draw each matched bbox
                    matchedBboxes.forEach((match, idx) => {
                        const [x1, y1, x2, y2] = match.bbox;
                        const width = x2 - x1;
                        const height = y2 - y1;
                        
                        // Generate color based on index (red, orange, yellow cycle)
                        const colors = [
                            { border: '#EF4444', fill: 'rgba(239, 68, 68, 0.15)', arrow: '#DC2626' },  // red
                            { border: '#F97316', fill: 'rgba(249, 115, 22, 0.15)', arrow: '#EA580C' }, // orange
                            { border: '#EAB308', fill: 'rgba(234, 179, 8, 0.15)', arrow: '#CA8A04' }   // yellow
                        ];
                        const color = colors[idx % colors.length];
                        
                        // 1. Draw semi-transparent rectangle fill
                        ctx.fillStyle = color.fill;
                        ctx.fillRect(x1, y1, width, height);
                        
                        // 2. Draw rectangle border (thick, rounded)
                        ctx.strokeStyle = color.border;
                        ctx.lineWidth = 4;
                        ctx.setLineDash([]);
                        ctx.strokeRect(x1, y1, width, height);
                        
                        // 3. Draw sequence number badge (top-left corner)
                        const badgeSize = Math.min(40, width / 3, height / 3);
                        const badgeX = x1;
                        const badgeY = y1;
                        
                        // Badge background circle
                        ctx.fillStyle = color.border;
                        ctx.beginPath();
                        ctx.arc(badgeX + badgeSize/2, badgeY - badgeSize/2, badgeSize/2, 0, Math.PI * 2);
                        ctx.fill();
                        
                        // Badge number
                        ctx.fillStyle = 'white';
                        ctx.font = `bold ${badgeSize * 0.6}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(idx + 1, badgeX + badgeSize/2, badgeY - badgeSize/2);
                        
                        // 4. Draw arrow pointing to center of bbox
                        const centerX = x1 + width / 2;
                        const centerY = y1 + height / 2;
                        const arrowStartX = x1 - 60;
                        const arrowStartY = y1 - 40;
                        
                        // Arrow line
                        ctx.strokeStyle = color.arrow;
                        ctx.lineWidth = 3;
                        ctx.setLineDash([8, 4]);
                        ctx.beginPath();
                        ctx.moveTo(arrowStartX, arrowStartY);
                        ctx.lineTo(x1 + 10, y1 + 10);
                        ctx.stroke();
                        
                        // Arrow head
                        ctx.setLineDash([]);
                        ctx.fillStyle = color.arrow;
                        ctx.beginPath();
                        const headSize = 12;
                        const angle = Math.atan2(y1 + 10 - arrowStartY, x1 + 10 - arrowStartX);
                        ctx.moveTo(x1 + 10, y1 + 10);
                        ctx.lineTo(
                            x1 + 10 - headSize * Math.cos(angle - Math.PI / 6),
                            y1 + 10 - headSize * Math.sin(angle - Math.PI / 6)
                        );
                        ctx.lineTo(
                            x1 + 10 - headSize * Math.cos(angle + Math.PI / 6),
                            y1 + 10 - headSize * Math.sin(angle + Math.PI / 6)
                        );
                        ctx.closePath();
                        ctx.fill();
                        
                        // 5. Draw matched text label near arrow start
                        const labelText = `${idx + 1}. ${match.text.substring(0, 20)}${match.text.length > 20 ? '...' : ''}`;
                        ctx.fillStyle = 'white';
                        ctx.strokeStyle = color.arrow;
                        ctx.lineWidth = 3;
                        ctx.font = 'bold 14px Arial';
                        ctx.textAlign = 'left';
                        ctx.textBaseline = 'bottom';
                        ctx.strokeText(labelText, arrowStartX, arrowStartY - 5);
                        ctx.fillText(labelText, arrowStartX, arrowStartY - 5);
                    });
                    
                    console.log(`‚úÖ Drew ${matchedBboxes.length} bboxes on canvas`);
                } else {
                    console.log('No search results found in global scope');
                }
            };
            
            img.onerror = function() {
                console.error('Failed to load image for bbox drawing:', imagePath);
                // Draw error message on canvas
                canvas.width = 400;
                canvas.height = 300;
                ctx.fillStyle = '#fee';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.fillStyle = '#c00';
                ctx.font = '16px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(currentLang === 'zh' ? 'ÂõæÁâáÂä†ËΩΩÂ§±Ë¥•' : 'Failed to load image', canvas.width/2, canvas.height/2);
            };
            
            img.src = imagePath;
        }
        
        // Toggle full content display
        // Toggle orphan document details
        function toggleOrphanDetails(orphanId) {
            const details = document.getElementById(`${orphanId}-details`);
            const toggle = document.getElementById(`${orphanId}-toggle`);
            
            if (details && toggle) {
                const isHidden = details.classList.contains('hidden');
                const showDetailsLabel = currentLang === 'zh' ? 'Êü•ÁúãËØ¶ÁªÜ‰ø°ÊÅØ' : 'View Details';
                const hideDetailsLabel = currentLang === 'zh' ? 'ÈöêËóèËØ¶ÁªÜ‰ø°ÊÅØ' : 'Hide Details';
                
                if (isHidden) {
                    details.classList.remove('hidden');
                    toggle.textContent = hideDetailsLabel;
                } else {
                    details.classList.add('hidden');
                    toggle.textContent = showDetailsLabel;
                }
            }
        }
        
        // Delete orphan document from ES
        async function deleteOrphanDocument(esDocId, resultIndex) {
            const confirmMsg = currentLang === 'zh' 
                ? 'Á°ÆÂÆöË¶Å‰ªé Elasticsearch Âà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰ΩúÊó†Ê≥ïÊí§ÈîÄ„ÄÇ' 
                : 'Are you sure you want to delete this record from Elasticsearch? This action cannot be undone.';
            
            if (!confirm(confirmMsg)) {
                return;
            }
            
            try {
                const response = await fetch(`/es-index/delete?es_doc_id=${esDocId}`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const result = await response.json();
                
                if (result.status === 'success') {
                    const successMsg = currentLang === 'zh' ? 'Âà†Èô§ÊàêÂäüÔºÅ' : 'Deleted successfully!';
                    alert(successMsg);
                    // Remove the result card from UI
                    const resultCard = document.querySelector(`#search-results > div:nth-child(${resultIndex + 1})`);
                    if (resultCard) {
                        resultCard.remove();
                    }
                } else {
                    throw new Error(result.message || 'Delete failed');
                }
            } catch (error) {
                const errorMsg = currentLang === 'zh' ? `Âà†Èô§Â§±Ë¥•: ${error.message}` : `Delete failed: ${error.message}`;
                alert(errorMsg);
            }
        }

        function toggleContent(contentId) {
            const preview = document.getElementById(`${contentId}-preview`);
            const full = document.getElementById(`${contentId}-full`);
            const toggleText = document.getElementById(`${contentId}-toggle-text`);
            
            if (full && preview && toggleText) {
                const isHidden = full.classList.contains('hidden');
                const showLessLabel = currentLang === 'zh' ? 'Êî∂Ëµ∑ÂÜÖÂÆπ' : 'Show Less';
                const showFullContentLabel = currentLang === 'zh' ? 'ÊòæÁ§∫ÂÆåÊï¥ÂÜÖÂÆπ' : 'Show Full Content';
                
                if (isHidden) {
                    full.classList.remove('hidden');
                    preview.classList.add('hidden');
                    toggleText.innerHTML = `<i class="fas fa-chevron-up"></i> ${showLessLabel}`;
                } else {
                    full.classList.add('hidden');
                    preview.classList.remove('hidden');
                    toggleText.innerHTML = `<i class="fas fa-chevron-down"></i> ${showFullContentLabel}`;
                }
            }
        }

        // Open full view modal
        function openFullView(imagePath) {
            const modal = document.createElement('div');
            modal.className = 'fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50';
            modal.onclick = () => modal.remove();
            modal.innerHTML = `
                <div class="relative max-w-6xl max-h-screen p-4">
                    <button onclick="this.closest('.fixed').remove()" class="absolute top-2 right-2 text-white bg-red-600 hover:bg-red-700 px-4 py-2 rounded">
                        <i class="fas fa-times"></i> Close
                    </button>
                    <img src="${imagePath}" class="max-w-full max-h-screen object-contain" onclick="event.stopPropagation()">
                </div>
            `;
            document.body.appendChild(modal);
        }
    </script>
</body>
</html>


